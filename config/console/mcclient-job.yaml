# (c) Copyright [2021-2022] Micro Focus or one of its affiliates.
# Licensed under the Apache License, Version 2.0 (the "License");
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: ConfigMap
metadata:
  name: script-init-mc
data:
  entrypoint.sh: |-
    #!/bin/bash
    
    set +o errexit
    set -o xtrace

    WEB_URL=$1
    INITIAL_PASSWORD=$2

    OP=$(java -jar /jars/MCClient.jar \
              -configure \
              -data_path /data \
              -catalog_path /data \
              -group_id verticadba \
              -home_dir /home/dbadmin \
              -license_dir /home/dbadmin/licensing/ce \
              -mc_dbadmin_user dbadmin \
              -mc_dbadmin_pwd $INITIAL_PASSWORD \
              -mc_port 5450 \
              -mc_url $WEB_URL 2>&1)
     RC=$?
     echo $OP

     # It is possible that we have already set up but fail waiting for the MC
     # to restart.  This error message indicates everything is already setup.
     if [[ $OP =~ "MC master passphrase already captured" ]]
     then
       echo "MC already setup.  Exiting cleanly."
       exit 0
     fi
     exit $RC
---
apiVersion: batch/v1
kind: Job
metadata:
  name: init-mc
  annotations:
    "helm.sh/hook": post-install
spec:
  ttlSecondsAfterFinished: 360
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: mcclient
          image: mcclient
          command:
            [
              "/bin/entrypoint.sh",
              "webui_url",
              "replace_password_here"
            ]
          volumeMounts:
          - name: entrypoint-volume
            mountPath: /bin/entrypoint.sh
            readOnly: true
            subPath: entrypoint.sh
      volumes:
      - name: entrypoint-volume
        configMap:
          defaultMode: 0777
          name: verticadb-operator-script-init-mc
